<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>RongChain 首页（v1.49）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; margin: 0; background: #f5f5f5; }
    .ver { position: fixed; right: 12px; top: 10px; color:#999; font-size:12px;}
    .topver { font-size:12px; color:#666; margin-bottom:8px;}
    h1 { margin: 8px 0 16px; }
    .content { padding-bottom: 160px; }
    .box { margin: 14px 0; padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    .label { font-weight: bold; margin-bottom: 6px; }
    .navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: space-around; align-items: center; background: #f1f1f1; border-top: 1px solid #ccc; }
    .nav-item { text-align: center; flex: 1; font-size: 14px; cursor: pointer; color: #333; }
    .nav-item:hover { color: #007bff; }
    .muted { color:#777; font-size: 12px; }
    .timeframe-buttons button, .refresh-buttons button { margin: 4px 6px 0 0; padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .timeframe-buttons button.active, .refresh-buttons button.active { background: #007bff; color:#fff; border:none; border-radius:4px; }
    .chart { width: 100%; height: 400px; }
  </style>
</head>
<body>
  <div class="ver">v1.49</div>
  <div class="topver">最高版本：v1.49</div>

  <div class="content">
    <h1>RongChain 首页</h1>
    <div id="wallet" class="muted">钱包地址: 检测中...</div>

    <div class="box">
      <div class="label">刷新间隔设置</div>
      <div class="refresh-buttons" id="refreshBtns">
        <button onclick="setRefresh(1000)" id="r1000">1 秒</button>
        <button onclick="setRefresh(3000)" id="r3000">3 秒</button>
        <button onclick="setRefresh(5000)" id="r5000">5 秒</button>
        <button onclick="setRefresh(10000)" id="r10000">10 秒</button>
      </div>
      <div class="muted">当前刷新间隔: <span id="curInterval"></span></div>
    </div>

    <div class="box">
      <div class="label">RongChain/USDT 现价</div>
      <div id="price">加载中...</div>
    </div>
    <div class="box">
      <div class="label">RongChain/CRC 现价（推导 USDT）</div>
      <div id="crcPrice">加载中...</div>
    </div>

    <!-- RONG 图表 -->
    <div class="box">
      <div class="label">RongChain 实时 K 线</div>
      <div class="timeframe-buttons" id="rfBtns">
        <button onclick="switchRongTF(1)" id="rbtn1">1 分钟</button>
        <button onclick="switchRongTF(5)" id="rbtn5">5 分钟</button>
        <button onclick="switchRongTF(15)" id="rbtn15">15 分钟</button>
        <button onclick="switchRongTF(60)" id="rbtn60">1 小时</button>
        <button onclick="switchRongTF(1440)" id="rbtn1440">日线</button>
      </div>
      <div id="rongChart" class="chart"></div>
    </div>

    <!-- CRC 图表 -->
    <div class="box">
      <div class="label">CRC 实时 K 线（推导 USDT）</div>
      <div class="timeframe-buttons" id="cfBtns">
        <button onclick="switchCrcTF(1)" id="cbtn1">1 分钟</button>
        <button onclick="switchCrcTF(5)" id="cbtn5">5 分钟</button>
        <button onclick="switchCrcTF(15)" id="cbtn15">15 分钟</button>
        <button onclick="switchCrcTF(60)" id="cbtn60">1 小时</button>
        <button onclick="switchCrcTF(1440)" id="cbtn1440">日线</button>
      </div>
      <div id="crcChart" class="chart"></div>
    </div>
  </div>

  <div class="navbar">
    <div class="nav-item">首页</div>
    <div class="nav-item">拼团</div>
    <div class="nav-item">赚币</div>
    <div class="nav-item">兑换</div>
    <div class="nav-item">我的</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // ===== 配置 =====
    const RONGCHAIN_TOKEN = "0x0337a015467af6605c4262d9f02a3dcd8b576f7e";
    const CRC_TOKEN       = "0x5b2fe2b06e714b7bea4fd35b428077d850c48087";
    const USDT            = "0x55d398326f99059ff775485246999027b3197955";
    const RONG_USDT_PAIR  = "0x7f20dE20b53b8145F75F7a7Bc55CC90AEFEeb795";
    const RONG_CRC_PAIR   = "0x8cDb69f2dDE96fB98FB5AfA6eB553eaB308D16a5";

    const erc20Abi = ["function decimals() view returns (uint8)"];
    const pairAbi = [
      "function token0() view returns (address)",
      "function token1() view returns (address)",
      "function getReserves() view returns (uint112,uint112,uint32)"
    ];

    const provider = new ethers.providers.Web3Provider(window.ethereum);

    async function priceFromPair(pairAddr, base, quote){
      const pair = new ethers.Contract(pairAddr, pairAbi, provider);
      const [t0,t1,res] = await Promise.all([pair.token0(), pair.token1(), pair.getReserves()]);
      const t0c = new ethers.Contract(t0, erc20Abi, provider);
      const t1c = new ethers.Contract(t1, erc20Abi, provider);
      const [d0,d1] = await Promise.all([t0c.decimals(), t1c.decimals()]);
      if(t0.toLowerCase()===base.toLowerCase() && t1.toLowerCase()===quote.toLowerCase()){
        return Number(ethers.utils.formatUnits(res[1], d1)) / Number(ethers.utils.formatUnits(res[0], d0));
      } else {
        return Number(ethers.utils.formatUnits(res[0], d0)) / Number(ethers.utils.formatUnits(res[1], d1));
      }
    }

    // ===== 更新价格 =====
    async function updatePrices(){
      try{
        const pRongUsdt = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        document.getElementById("price").innerText = pRongUsdt.toFixed(6)+" USDT";
        const pRongCrc = await priceFromPair(RONG_CRC_PAIR, RONGCHAIN_TOKEN, CRC_TOKEN);
        const pCrcUsdt = pRongUsdt / pRongCrc;
        document.getElementById("crcPrice").innerText = pRongCrc.toFixed(6)+" CRC (≈ "+pCrcUsdt.toFixed(6)+" USDT)";
      }catch(e){ console.log("价格失败", e); }
    }

    // ===== 图表 =====
    function createChart(containerId){
      return LightweightCharts.createChart(document.getElementById(containerId), {width:document.getElementById(containerId).clientWidth, height:400});
    }

    // Rong 图表
    let rChart=createChart("rongChart"), rSeries=rChart.addCandlestickSeries(), rCandles=[], rBucket=null, rTF=parseInt(localStorage.getItem("rong_tf")||1);
    function switchRongTF(min){
      rTF=min; localStorage.setItem("rong_tf",min);
      rCandles=[]; rSeries.setData([]); markActive("rfBtns","rbtn"+min);
    }
    async function updateRongCandle(){
      try{
        const p = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        const now=Date.now(), bucket=Math.floor(now/(rTF*60000));
        if(rBucket!==bucket){ rBucket=bucket; rCandles.push({time:Math.floor(now/1000),open:p,high:p,low:p,close:p}); }
        else{ let c=rCandles[rCandles.length-1]; c.high=Math.max(c.high,p); c.low=Math.min(c.low,p); c.close=p; }
        rSeries.setData(rCandles);
      }catch(e){}
    }

    // CRC 图表
    let cChart=createChart("crcChart"), cSeries=cChart.addCandlestickSeries(), cCandles=[], cBucket=null, cTF=parseInt(localStorage.getItem("crc_tf")||1);
    function switchCrcTF(min){
      cTF=min; localStorage.setItem("crc_tf",min);
      cCandles=[]; cSeries.setData([]); markActive("cfBtns","cbtn"+min);
    }
    async function updateCrcCandle(){
      try{
        const pRongUsdt = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        const pRongCrc  = await priceFromPair(RONG_CRC_PAIR, RONGCHAIN_TOKEN, CRC_TOKEN);
        const p = pRongUsdt / pRongCrc; // CRC/USDT
        const now=Date.now(), bucket=Math.floor(now/(cTF*60000));
        if(cBucket!==bucket){ cBucket=bucket; cCandles.push({time:Math.floor(now/1000),open:p,high:p,low:p,close:p}); }
        else{ let c=cCandles[cCandles.length-1]; c.high=Math.max(c.high,p); c.low=Math.min(c.low,p); c.close=p; }
        cSeries.setData(cCandles);
      }catch(e){}
    }

    function markActive(groupId,activeId){
      document.querySelectorAll("#"+groupId+" button").forEach(b=>b.classList.remove("active"));
      document.getElementById(activeId).classList.add("active");
    }

    // ===== 刷新控制 =====
    let refreshInterval = parseInt(localStorage.getItem("refresh_ms")||1000);
    let refreshTimer;

    function setRefresh(ms){
      refreshInterval = ms;
      localStorage.setItem("refresh_ms",ms);
      document.getElementById("curInterval").innerText = ms/1000+" 秒";
      document.querySelectorAll("#refreshBtns button").forEach(b=>b.classList.remove("active"));
      document.getElementById("r"+ms).classList.add("active");
      restartTimers();
    }

    function restartTimers(){
      if(refreshTimer){ clearInterval(refreshTimer); }
      refreshTimer = setInterval(()=>{
        updatePrices();
        updateRongCandle();
        updateCrcCandle();
      }, refreshInterval);
    }

    // ===== 启动 =====
    switchRongTF(rTF); switchCrcTF(cTF);
    setRefresh(refreshInterval); // 恢复上次选择的刷新间隔
  </script>
</body>
</html>
