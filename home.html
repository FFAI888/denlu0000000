<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>RongChain é¦–é¡µï¼ˆv1.45ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; margin: 0; background: #f5f5f5; }
    .ver { position: fixed; right: 12px; top: 10px; color:#999; font-size:12px;}
    .topver { font-size:12px; color:#666; margin-bottom:8px;}
    h1 { margin: 8px 0 16px; }
    .content { padding-bottom: 140px; }
    .box { margin: 14px 0; padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    .label { font-weight: bold; margin-bottom: 6px; }
    .admin-box { margin: 14px 0; padding: 14px; border: 2px solid #007bff; border-radius: 8px; background: #e9f3ff; display: none; }
    .admin-box button { padding: 10px 15px; font-size: 14px; cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 6px; }
    .navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: space-around; align-items: center; background: #f1f1f1; border-top: 1px solid #ccc; }
    .nav-item { text-align: center; flex: 1; font-size: 14px; cursor: pointer; color: #333; }
    .nav-item:hover { color: #007bff; }
    .muted { color:#777; font-size: 12px; }
    .timeframe-buttons button { margin: 4px 6px 0 0; padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .timeframe-buttons button.active { background: #007bff; color:#fff; border:none; border-radius:4px; }
    .chart { width: 100%; height: 400px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 920px) {
      .row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="ver">v1.45</div>
  <div class="topver">æœ€é«˜ç‰ˆæœ¬ï¼šv1.45</div>

  <div class="content">
    <h1>RongChain é¦–é¡µ</h1>
    <div id="wallet" class="muted">é’±åŒ…åœ°å€: æ£€æµ‹ä¸­...</div>

    <div class="box">
      <div class="label">åœ°å€æ£€æµ‹çŠ¶æ€</div>
      <div id="addressStatus" class="muted">æ­£åœ¨æ£€æµ‹ä¸­...</div>
    </div>

    <div class="row">
      <div class="box">
        <div class="label">RongChain ä½™é¢</div>
        <div id="balance" class="muted">æ£€æµ‹ä¸­...</div>
      </div>
      <div class="box">
        <div class="label">CRC ä½™é¢</div>
        <div id="crcBalance" class="muted">æ£€æµ‹ä¸­...</div>
      </div>
    </div>

    <div class="row">
      <div class="box">
        <div class="label">RongChain/USDT ä»·æ ¼</div>
        <div id="price" class="muted">åŠ è½½ä¸­...</div>
      </div>
      <div class="box">
        <div class="label">RongChain/CRC ä»·æ ¼ï¼ˆå«æ¨å¯¼ USDTï¼‰</div>
        <div id="crcPrice" class="muted">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- ğŸ“Š å·¦ï¼šRong å®æ—¶ K çº¿ï¼ˆé“¾ä¸Šé‡‡æ ·èšåˆï¼Œå·²å®ç°ï¼‰ -->
    <div class="box">
      <div class="label">RongChain å®æ—¶ K çº¿</div>
      <div class="timeframe-buttons" id="rfBtns">
        <button onclick="switchRongTF(1)" id="rbtn1">1 åˆ†é’Ÿ</button>
        <button onclick="switchRongTF(5)" id="rbtn5">5 åˆ†é’Ÿ</button>
        <button onclick="switchRongTF(15)" id="rbtn15">15 åˆ†é’Ÿ</button>
        <button onclick="switchRongTF(60)" id="rbtn60">1 å°æ—¶</button>
        <button onclick="switchRongTF(1440)" id="rbtn1440">æ—¥çº¿</button>
        <button onclick="switchRongTF(10080)" id="rbtn10080">å‘¨çº¿</button>
        <button onclick="switchRongTF(43200)" id="rbtn43200">æœˆçº¿</button>
      </div>
      <div id="rongChart" class="chart"></div>
      <div class="muted">æ•°æ®æºï¼šRONG/USDT æ± å­é“¾ä¸Šä»·æ ¼å¿«ç…§ï¼ˆå‰ç«¯èšåˆï¼‰ã€‚</div>
    </div>

    <!-- ğŸ“Š å³ï¼šCRC å®æ—¶ K çº¿ï¼ˆGeckoTerminal ä¼˜å…ˆï¼Œå¤±è´¥åˆ™ç”¨é“¾ä¸Šæ¨å¯¼èšåˆï¼‰ -->
    <div class="box">
      <div class="label">CRC å®æ—¶ K çº¿ï¼ˆä¼˜å…ˆ GeckoTerminalï¼Œå¤±è´¥åˆ™é“¾ä¸Šæ¨å¯¼ï¼‰</div>
      <div class="timeframe-buttons" id="cfBtns">
        <button onclick="loadCrcCandles('1m')" id="cbtn1m">1 åˆ†é’Ÿ</button>
        <button onclick="loadCrcCandles('5m')" id="cbtn5m">5 åˆ†é’Ÿ</button>
        <button onclick="loadCrcCandles('15m')" id="cbtn15m">15 åˆ†é’Ÿ</button>
        <button onclick="loadCrcCandles('1h')" id="cbtn1h">1 å°æ—¶</button>
        <button onclick="loadCrcCandles('1d')" id="cbtn1d">æ—¥çº¿</button>
        <button onclick="loadCrcCandles('1w')" id="cbtn1w">å‘¨çº¿</button>
      </div>
      <div id="crcChart" class="chart"></div>
      <div id="crcSource" class="muted">æ•°æ®æºï¼šå°è¯• GeckoTerminal...</div>
    </div>

    <div class="admin-box" id="adminBox">
      <div class="label">ç®¡ç†å‘˜åŠŸèƒ½</div>
      <button onclick="goAdmin()">è¿›å…¥ç®¡ç†åå°</button>
    </div>
  </div>

  <div class="navbar">
    <div class="nav-item">é¦–é¡µ</div>
    <div class="nav-item">æ‹¼å›¢</div>
    <div class="nav-item">èµšå¸</div>
    <div class="nav-item">å…‘æ¢</div>
    <div class="nav-item">æˆ‘çš„</div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    // ===== åŸºç¡€é…ç½® =====
    const ACCOUNT_PARAM = new URLSearchParams(window.location.search).get("account");
    const RONGCHAIN_TOKEN = "0x0337a015467af6605c4262d9f02a3dcd8b576f7e";
    const CRC_TOKEN       = "0x5b2fe2b06e714b7bea4fd35b428077d850c48087";
    const USDT            = "0x55d398326f99059ff775485246999027b3197955";
    const RONG_USDT_PAIR  = "0x7f20dE20b53b8145F75F7a7Bc55CC90AEFEeb795";
    const RONG_CRC_PAIR   = "0x8cDb69f2dDE96fB98FB5AfA6eB553eaB308D16a5";
    // GeckoTerminalï¼šBSC ç½‘ç»œ + ä½ çš„ CRC æ± ï¼ˆæ³¨æ„ï¼šæœ‰äº›æ± å­å¯èƒ½æš‚æœªè¢«æ”¶å½•ï¼‰
    // è§„èŒƒè·¯å¾„é€šå¸¸ä¸º /api/v2/networks/{network}/pools/{pool}/candles?interval=1m
    const GECKO_NETWORK = "bsc";
    const GECKO_POOL    = "0x8cDb69f2dDE96fB98FB5AfA6eB553eaB308D16a5";

    const erc20Abi = [
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)"
    ];
    const pairAbi = [
      "function token0() view returns (address)",
      "function token1() view returns (address)",
      "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
    ];

    const account = ACCOUNT_PARAM;
    if (account) document.getElementById("wallet").innerText = "é’±åŒ…åœ°å€: " + account;

    function checkAddressValid() {
      if (account && ethers.utils.isAddress(account)) {
        document.getElementById("addressStatus").innerText = "âœ… åœ°å€æœ‰æ•ˆ";
      } else {
        document.getElementById("addressStatus").innerText = "âŒ åœ°å€æ— æ•ˆæˆ–æœªç™»å½•";
      }
    }
    function goAdmin(){ window.location.href = "admin.html?account=" + account; }

    // ===== ä½™é¢ =====
    async function fetchBalance(tokenAddr, elId) {
      try {
        if (!window.ethereum || !account) throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…æˆ–æœªç™»å½•");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const contract = new ethers.Contract(tokenAddr, erc20Abi, provider);
        const [dec, sym, bal] = await Promise.all([contract.decimals(), contract.symbol(), contract.balanceOf(account)]);
        const formatted = ethers.utils.formatUnits(bal, dec);
        document.getElementById(elId).innerText = formatted + " " + sym;
      } catch (e) {
        document.getElementById(elId).innerText = "âŒ ä½™é¢è·å–å¤±è´¥";
      }
    }

    // ===== é“¾ä¸Šä»·æ ¼ï¼ˆç”¨å‚¨å¤‡è®¡ç®—ï¼‰ =====
    async function priceFromPair(pairAddr, base, quote) {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const pair = new ethers.Contract(pairAddr, pairAbi, provider);
      const [t0, t1, res] = await Promise.all([pair.token0(), pair.token1(), pair.getReserves()]);
      const token0 = t0.toLowerCase(), token1 = t1.toLowerCase();
      const r0 = ethers.BigNumber.from(res.reserve0.toString());
      const r1 = ethers.BigNumber.from(res.reserve1.toString());
      const t0c = new ethers.Contract(token0, erc20Abi, provider);
      const t1c = new ethers.Contract(token1, erc20Abi, provider);
      const [d0, d1] = await Promise.all([t0c.decimals(), t1c.decimals()]);
      const [b, q] = [base.toLowerCase(), quote.toLowerCase()];

      if (token0 === b && token1 === q) {
        return Number(ethers.utils.formatUnits(r1, d1)) / Number(ethers.utils.formatUnits(r0, d0));
      } else if (token1 === b && token0 === q) {
        return Number(ethers.utils.formatUnits(r0, d0)) / Number(ethers.utils.formatUnits(r1, d1));
      }
      throw new Error("é…å¯¹ä¸åŒ…å«æŒ‡å®š base/quote");
    }

    // ===== é¡µé¢ä»·æ ¼åŒºï¼šRONG/USDT & RONG/CRCï¼ˆå«æ¨å¯¼ USDTï¼‰ =====
    let rongUsdt = null, rongCrc = null;
    async function updateSpotPrices(){
      try {
        rongUsdt = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        document.getElementById("price").innerText = `â‰ˆ ${rongUsdt.toFixed(6)} USDT`;
      } catch { document.getElementById("price").innerText = "âŒ è·å–å¤±è´¥"; }

      try {
        rongCrc = await priceFromPair(RONG_CRC_PAIR, RONGCHAIN_TOKEN, CRC_TOKEN);
        if (rongUsdt) {
          const crcUsdt = rongUsdt / rongCrc; // 1 CRC çš„ USDT ä»·
          document.getElementById("crcPrice").innerText = `â‰ˆ ${rongCrc.toFixed(6)} CRCï¼ˆæ¨å¯¼â‰ˆ ${crcUsdt.toFixed(6)} USDT/CRCï¼‰`;
        } else {
          document.getElementById("crcPrice").innerText = `â‰ˆ ${rongCrc.toFixed(6)} CRC`;
        }
      } catch { document.getElementById("crcPrice").innerText = "âŒ è·å–å¤±è´¥"; }
    }

    // ===== Rong å›¾è¡¨ï¼ˆé“¾ä¸Šé‡‡æ ·èšåˆï¼‰ =====
    let rChart=null, rSeries=null, rCandles=[], rBucket=null, rTF=Number(localStorage.getItem("rong_tf")||1440);
    function initRongChart(){
      if (rChart) rChart.remove();
      rChart = LightweightCharts.createChart(document.getElementById('rongChart'), { width: document.getElementById('rongChart').clientWidth, height: 400 });
      rSeries = rChart.addCandlestickSeries();
      window.addEventListener('resize', ()=> rChart.applyOptions({ width: document.getElementById('rongChart').clientWidth }));
      markActiveButtons('rfBtns', `rbtn${rTF}`);
    }
    function switchRongTF(min){
      rTF=min; localStorage.setItem("rong_tf", String(min));
      rCandles=[]; rBucket=null; rSeries.setData([]);
      markActiveButtons('rfBtns', `rbtn${min}`);
    }
    async function updateRongCandle(){
      try{
        const p = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        const now=Date.now(), bucket=Math.floor(now/(rTF*60000));
        if (rBucket!==bucket){ rBucket=bucket; rCandles.push({time:Math.floor(now/1000), open:p, high:p, low:p, close:p}); }
        else{ const c=rCandles[rCandles.length-1]; c.high=Math.max(c.high,p); c.low=Math.min(c.low,p); c.close=p; }
        rSeries.setData(rCandles);
      }catch(e){ console.log("RONG Kçº¿å¤±è´¥", e); }
    }

    // ===== CRC å›¾è¡¨ï¼ˆGecko ä¼˜å…ˆï¼›å¤±è´¥åˆ™é“¾ä¸Šæ¨å¯¼èšåˆï¼‰ =====
    let cChart=null, cSeries=null, cCandles=[], cBucket=null, cTFKey="crc_tf", cTF="1d", cMode="gecko";
    const validIntervals = ["1m","5m","15m","1h","1d","1w"];

    function initCrcChart(){
      if (cChart) cChart.remove();
      cChart = LightweightCharts.createChart(document.getElementById('crcChart'), { width: document.getElementById('crcChart').clientWidth, height: 400 });
      cSeries = cChart.addCandlestickSeries();
      window.addEventListener('resize', ()=> cChart.applyOptions({ width: document.getElementById('crcChart').clientWidth }));
      // æ¢å¤ä¸Šæ¬¡é€‰æ‹©
      const saved = localStorage.getItem(cTFKey);
      if (saved && validIntervals.includes(saved)) { cTF=saved; }
      markActiveButtons('cfBtns', `cbtn${cTF}`);
      // åˆæ¬¡åŠ è½½
      loadCrcCandles(cTF);
    }

    function markActiveButtons(groupId, activeId){
      document.querySelectorAll(`#${groupId} button`).forEach(b=>b.classList.remove("active"));
      const el = document.getElementById(activeId);
      if (el) el.classList.add("active");
    }

    async function geckoFetchCandles(interval){
      // GeckoTerminal APIï¼ˆè‹¥è¯¥æ± å·²æ”¶å½•ï¼‰
      const url = `https://api.geckoterminal.com/api/v2/networks/${GECKO_NETWORK}/pools/${GECKO_POOL}/candles?interval=${interval}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Gecko API å“åº”å¤±è´¥");
      const json = await res.json();
      // å…¼å®¹ä¸åŒç»“æ„ï¼šdata æˆ– attributes
      const rows = (json.data || []).map(x => {
        const a = x.attributes || {};
        return {
          time: Math.floor(new Date(a.timestamp).getTime()/1000),
          open: Number(a.open), high: Number(a.high), low: Number(a.low), close: Number(a.close)
        }
      }).filter(d => Number.isFinite(d.open));
      if (!rows.length) throw new Error("Gecko è¿”å›ç©ºæ•°æ®");
      return rows;
    }

    async function loadCrcCandles(interval){
      cTF = interval; localStorage.setItem(cTFKey, interval);
      markActiveButtons('cfBtns', `cbtn${interval}`);
      document.getElementById("crcSource").innerText = "æ•°æ®æºï¼šå°è¯• GeckoTerminal...";
      try{
        const rows = await geckoFetchCandles(interval);
        cSeries.setData(rows);
        cMode = "gecko";
        document.getElementById("crcSource").innerText = "æ•°æ®æºï¼šGeckoTerminalï¼ˆPancake æ± å­èœ¡çƒ›ï¼‰";
      }catch(e){
        // å›é€€åˆ°å‰ç«¯æ¨å¯¼
        console.log("Gecko å¤±è´¥ï¼Œå›é€€åˆ°å‰ç«¯æ¨å¯¼", e);
        cMode = "local";
        cCandles=[]; cBucket=null; cSeries.setData([]);
        document.getElementById("crcSource").innerText = "æ•°æ®æºï¼šé“¾ä¸Šæ¨å¯¼ï¼ˆRONG/USDT ä¸ RONG/CRC ä»·æ ¼èšåˆï¼‰";
      }
    }

    // å‰ç«¯æ¨å¯¼ CRC/USDTï¼šæ¯æ¬¡é‡‡æ · p_crc_usdt = (RONG/USDT) / (RONG/CRC)
    function intervalToMinutes(interval){
      if (interval.endsWith("m")) return parseInt(interval);
      if (interval.endsWith("h")) return parseInt(interval)*60;
      if (interval==="1d") return 1440;
      if (interval==="1w") return 10080;
      return 1440;
    }
    async function updateCrcLocalCandle(){
      if (cMode!=="local") return;
      try{
        const pRongUsdt = await priceFromPair(RONG_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        const pRongCrc  = await priceFromPair(RONG_CRC_PAIR, RONGCHAIN_TOKEN, CRC_TOKEN);
        if (!pRongUsdt || !pRongCrc) return;
        const pCrcUsdt = pRongUsdt / pRongCrc;

        const tfMin = intervalToMinutes(cTF);
        const now = Date.now();
        const bucket = Math.floor(now/(tfMin*60000));
        if (cBucket!==bucket){
          cBucket=bucket;
          cCandles.push({time: Math.floor(now/1000), open:pCrcUsdt, high:pCrcUsdt, low:pCrcUsdt, close:pCrcUsdt});
        }else{
          const c=cCandles[cCandles.length-1];
          c.high=Math.max(c.high,pCrcUsdt);
          c.low =Math.min(c.low ,pCrcUsdt);
          c.close=pCrcUsdt;
        }
        cSeries.setData(cCandles);
      }catch(e){ console.log("CRC æœ¬åœ°æ¨å¯¼æ›´æ–°å¤±è´¥", e); }
    }

    // ===== æ™®é€šä¿¡æ¯åˆ·æ–° =====
    function refreshAll(){
      checkAddressValid();
      fetchBalance(RONGCHAIN_TOKEN, "balance");
      fetchBalance(CRC_TOKEN, "crcBalance");
      updateSpotPrices();
    }

    // ===== å¯åŠ¨ =====
    // åœ°å€çŠ¶æ€ & ä½™é¢ & ç°ä»·
    refreshAll();
    setInterval(refreshAll, 1000);

    // RONG å›¾è¡¨
    initRongChart();
    switchRongTF(rTF);              // æŒ‰ä¸Šæ¬¡è®°å¿†æˆ–é»˜è®¤
    setInterval(updateRongCandle, 10000);

    // CRC å›¾è¡¨
    initCrcChart();
    // å‘¨æœŸå˜åŒ–æ—¶ï¼Œè‹¥åœ¨ local æ¨¡å¼ï¼Œåˆ™é‡ç½®æœ¬åœ°èšåˆå®¹å™¨
    //ï¼ˆå·²åœ¨ loadCrcCandles ä¸­å¤„ç†ï¼‰

    // å®šæ—¶å°è¯•ï¼šè‹¥ CRC å›¾è¡¨å¤„äº local å›é€€æ¨¡å¼ï¼Œå°±ç”¨å‰ç«¯æ¨å¯¼é©±åŠ¨
    setInterval(updateCrcLocalCandle, 10000);

    // è‡ªé€‚åº”å®½åº¦
    window.addEventListener('resize', ()=>{
      if (rChart) rChart.applyOptions({ width: document.getElementById('rongChart').clientWidth });
      if (cChart) cChart.applyOptions({ width: document.getElementById('crcChart').clientWidth });
    });
  </script>
</body>
</html>
