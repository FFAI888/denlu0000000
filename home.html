<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>RongChain é¦–é¡µï¼ˆv1.41ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; margin: 0; background: #f5f5f5; }
    .ver { position: fixed; right: 12px; top: 10px; color:#999; font-size:12px;}
    .topver { font-size:12px; color:#666; margin-bottom:8px;}
    h1 { margin: 8px 0 16px; }
    .content { padding-bottom: 120px; }
    .box { margin: 14px 0; padding: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    .label { font-weight: bold; margin-bottom: 6px; }
    .admin-box { margin: 14px 0; padding: 14px; border: 2px solid #007bff; border-radius: 8px; background: #e9f3ff; display: none; }
    .admin-box button { padding: 10px 15px; font-size: 14px; cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 6px; }
    .navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: space-around; align-items: center; background: #f1f1f1; border-top: 1px solid #ccc; }
    .nav-item { text-align: center; flex: 1; font-size: 14px; cursor: pointer; color: #333; }
    .nav-item:hover { color: #007bff; }
    iframe { width: 100%; height: 420px; border: none; margin-top: 8px; border-radius:8px; }
    .muted { color:#777; font-size: 12px; }
    .timeframe-buttons button { margin: 4px 6px 0 0; padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .timeframe-buttons button.active { background: #007bff; color:#fff; border:none; border-radius:4px; }
    #chart { width: 100%; height: 400px; }
  </style>
</head>
<body>
  <div class="ver">v1.41</div>
  <div class="topver">æœ€é«˜ç‰ˆæœ¬ï¼šv1.41</div>
  <div class="content">
    <h1>RongChain é¦–é¡µ</h1>
    <div id="wallet" class="muted">é’±åŒ…åœ°å€: æ£€æµ‹ä¸­...</div>

    <div class="box">
      <div class="label">åœ°å€æ£€æµ‹çŠ¶æ€</div>
      <div id="addressStatus" class="muted">æ­£åœ¨æ£€æµ‹ä¸­...</div>
    </div>

    <div class="box">
      <div class="label">RongChain ä½™é¢</div>
      <div id="balance" class="muted">æ£€æµ‹ä¸­...</div>
    </div>

    <div class="box">
      <div class="label">CRC ä½™é¢</div>
      <div id="crcBalance" class="muted">æ£€æµ‹ä¸­...</div>
    </div>

    <div class="box">
      <div class="label">RongChain/USDT ä»·æ ¼</div>
      <div id="price" class="muted">åŠ è½½ä¸­...</div>
    </div>

    <div class="box">
      <div class="label">RongChain/CRC ä»·æ ¼ï¼ˆå«æ¨å¯¼ USDTï¼‰</div>
      <div id="crcPrice" class="muted">åŠ è½½ä¸­...</div>
    </div>

    <!-- ğŸ“Š å®æ—¶ K çº¿å›¾ -->
    <div class="box">
      <div class="label">RongChain å®æ—¶ K çº¿</div>
      <div class="timeframe-buttons">
        <button onclick="switchTimeframe(1)" id="btn1">1 åˆ†é’Ÿ</button>
        <button onclick="switchTimeframe(5)" id="btn5">5 åˆ†é’Ÿ</button>
        <button onclick="switchTimeframe(15)" id="btn15">15 åˆ†é’Ÿ</button>
        <button onclick="switchTimeframe(60)" id="btn60">1 å°æ—¶</button>
        <button onclick="switchTimeframe(1440)" id="btn1440">æ—¥çº¿</button>
        <button onclick="switchTimeframe(10080)" id="btn10080">å‘¨çº¿</button>
        <button onclick="switchTimeframe(43200)" id="btn43200">æœˆçº¿</button>
      </div>
      <div id="chart"></div>
    </div>

    <div class="admin-box" id="adminBox">
      <div class="label">ç®¡ç†å‘˜åŠŸèƒ½</div>
      <button onclick="goAdmin()">è¿›å…¥ç®¡ç†åå°</button>
    </div>
  </div>

  <div class="navbar">
    <div class="nav-item">é¦–é¡µ</div>
    <div class="nav-item">æ‹¼å›¢</div>
    <div class="nav-item">èµšå¸</div>
    <div class="nav-item">å…‘æ¢</div>
    <div class="nav-item">æˆ‘çš„</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    // ===== é…ç½® =====
    const ACCOUNT_PARAM = new URLSearchParams(window.location.search).get("account");
    const RONGCHAIN_TOKEN      = "0x0337a015467af6605c4262d9f02a3dcd8b576f7e";
    const CRC_TOKEN            = "0x5b2fe2b06e714b7bea4fd35b428077d850c48087";
    const USDT                 = "0x55d398326f99059ff775485246999027b3197955";
    const RONGCHAIN_USDT_PAIR  = "0x7f20dE20b53b8145F75F7a7Bc55CC90AEFEeb795";

    const erc20Abi = [
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)"
    ];
    const pairAbi = [
      "function token0() view returns (address)",
      "function token1() view returns (address)",
      "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
    ];

    const account = ACCOUNT_PARAM;
    if (account) document.getElementById("wallet").innerText = "é’±åŒ…åœ°å€: " + account;

    function checkAddressValid() {
      if (account && ethers.utils.isAddress(account)) {
        document.getElementById("addressStatus").innerText = "âœ… åœ°å€æœ‰æ•ˆ";
      } else {
        document.getElementById("addressStatus").innerText = "âŒ åœ°å€æ— æ•ˆæˆ–æœªç™»å½•";
      }
    }

    function goAdmin() {
      window.location.href = "admin.html?account=" + account;
    }

    // ===== ä½™é¢ =====
    async function fetchBalance(tokenAddr, elId) {
      try {
        if (!window.ethereum || !account) throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…æˆ–æœªç™»å½•");
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const contract = new ethers.Contract(tokenAddr, erc20Abi, provider);
        const [dec, sym, bal] = await Promise.all([
          contract.decimals(),
          contract.symbol(),
          contract.balanceOf(account)
        ]);
        const formatted = ethers.utils.formatUnits(bal, dec);
        document.getElementById(elId).innerText = formatted + " " + sym;
      } catch (e) {
        document.getElementById(elId).innerText = "âŒ ä½™é¢è·å–å¤±è´¥";
      }
    }

    // ===== ä»·æ ¼ =====
    async function fetchPriceFromOnchain(pairAddr, baseTokenAddr, quoteTokenAddr) {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const pair = new ethers.Contract(pairAddr, pairAbi, provider);
      const [t0, t1, reserves] = await Promise.all([pair.token0(), pair.token1(), pair.getReserves()]);
      const token0 = t0.toLowerCase(), token1 = t1.toLowerCase();
      const r0 = ethers.BigNumber.from(reserves.reserve0.toString());
      const r1 = ethers.BigNumber.from(reserves.reserve1.toString());
      const t0c = new ethers.Contract(token0, erc20Abi, provider);
      const t1c = new ethers.Contract(token1, erc20Abi, provider);
      const [d0, d1] = await Promise.all([t0c.decimals(), t1c.decimals()]);
      const base = baseTokenAddr.toLowerCase();
      const quote = quoteTokenAddr.toLowerCase();
      if (token0 === base && token1 === quote) {
        return Number(ethers.utils.formatUnits(r1, d1)) / Number(ethers.utils.formatUnits(r0, d0));
      } else if (token1 === base && token0 === quote) {
        return Number(ethers.utils.formatUnits(r0, d0)) / Number(ethers.utils.formatUnits(r1, d1));
      } else {
        throw new Error("é…å¯¹ä¸åŒ…å«æŒ‡å®š base/quote");
      }
    }

    // ===== å®æ—¶ K çº¿é€»è¾‘ =====
    let chart = null;
    let candleSeries = null;
    let candles = [];
    let currentBucket = null;
    let timeframe = 1440; // é»˜è®¤æ—¥çº¿

    function initChart() {
      if (chart) chart.remove();
      chart = LightweightCharts.createChart(document.getElementById('chart'), { width: document.getElementById('chart').clientWidth, height: 400 });
      candleSeries = chart.addCandlestickSeries();
    }

    function resizeChart() {
      if (chart) {
        chart.applyOptions({ width: document.getElementById('chart').clientWidth });
      }
    }
    window.addEventListener('resize', resizeChart);

    function switchTimeframe(min) {
      timeframe = min;
      localStorage.setItem("rongchain_timeframe", min); // è®°ä½ç”¨æˆ·é€‰æ‹©
      candles = [];
      currentBucket = null;
      candleSeries.setData([]);
      document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove("active"));
      document.getElementById("btn"+min).classList.add("active");
    }

    async function updateCandle() {
      try {
        const price = await fetchPriceFromOnchain(RONGCHAIN_USDT_PAIR, RONGCHAIN_TOKEN, USDT);
        const now = new Date();
        const bucket = Math.floor(now.getTime() / (timeframe * 60000));
        if (currentBucket !== bucket) {
          currentBucket = bucket;
          candles.push({ time: Math.floor(now.getTime() / 1000), open: price, high: price, low: price, close: price });
        } else {
          const c = candles[candles.length - 1];
          c.high = Math.max(c.high, price);
          c.low = Math.min(c.low, price);
          c.close = price;
        }
        candleSeries.setData(candles);
      } catch (e) { console.log("ä»·æ ¼è·å–å¤±è´¥", e); }
    }

    // ===== å®šæ—¶ä»»åŠ¡ =====
    function refreshAll() {
      checkAddressValid();
      fetchBalance(RONGCHAIN_TOKEN, "balance");
      fetchBalance(CRC_TOKEN, "crcBalance");
    }

    initChart();

    // ä» localStorage æ¢å¤ç”¨æˆ·ä¸Šæ¬¡é€‰æ‹©çš„å‘¨æœŸ
    const saved = localStorage.getItem("rongchain_timeframe");
    if (saved) {
      switchTimeframe(Number(saved));
    } else {
      switchTimeframe(1440); // é»˜è®¤æ—¥çº¿
    }

    refreshAll();
    setInterval(refreshAll, 1000);
    setInterval(updateCandle, 10000);
  </script>
</body>
</html>
