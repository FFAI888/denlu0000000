<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>RongChain DApp 首页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .content {
      padding-bottom: 200px;
    }
    .box {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
    }
    .label {
      font-weight: bold;
      margin-bottom: 8px;
    }
    .admin-box {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background: #e9f3ff;
      display: none;
    }
    .admin-box button {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #f1f1f1;
      border-top: 1px solid #ccc;
    }
    .nav-item {
      text-align: center;
      flex: 1;
      font-size: 14px;
      cursor: pointer;
      color: #333;
    }
    .nav-item:hover {
      color: #007bff;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="content">
    <h1>RongChain 首页</h1>
    <div id="wallet">钱包地址: 检测中...</div>

    <div class="box">
      <div class="label">地址检测状态</div>
      <div id="addressStatus">正在检测中...</div>
    </div>

    <div class="box">
      <div class="label">RongChain 余额</div>
      <div id="balance">检测中...</div>
    </div>

    <div class="box">
      <div class="label">CRC 余额</div>
      <div id="crcBalance">检测中...</div>
    </div>

    <div class="box">
      <div class="label">RongChain/USDT 价格</div>
      <div id="price">加载中...</div>
    </div>

    <div class="box">
      <div class="label">RongChain/CRC 价格</div>
      <div id="crcPrice">加载中...</div>
    </div>

    <div class="admin-box" id="adminBox">
      <div class="label">管理员功能</div>
      <button onclick="goAdmin()">进入管理后台</button>
    </div>

    <h2>K 线行情 (RongChain/USDT)</h2>
    <iframe src="https://s.tradingview.com/widgetembed/?symbol=BINANCE:ETHUSDT&interval=15&hidesidetoolbar=1&theme=light&style=1&timezone=Asia%2FShanghai"></iframe>
  </div>

  <div class="navbar">
    <div class="nav-item">首页</div>
    <div class="nav-item">拼团</div>
    <div class="nav-item">赚币</div>
    <div class="nav-item">兑换</div>
    <div class="nav-item">我的</div>
  </div>

  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const account = params.get("account");
    if (account) document.getElementById("wallet").innerText = "钱包地址: " + account;

    // === 合约 & 代币配置 ===
    const RONGCHAIN_TOKEN = "0x0337a015467af6605c4262d9f02a3dcd8b576f7e";
    const CRC_TOKEN = "0x5b2fe2b06e714b7bea4fd35b428077d850c48087";
    const RONGCHAIN_USDT_PAIR = "0x7f20dE20b53b8145F75F7a7Bc55CC90AEFEeb795";
    const RONGCHAIN_CRC_PAIR  = "0x8cDb69f2dDE96fB98FB5AfA6eB553eaB308D16a5";
    const WHITELIST_CONTRACT = "0xa1852413ca02e6d2f653dd88586eae822e790d96b1e1aabcfc9d0a70b1175c66";

    const erc20Abi = [
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint256)"
    ];
    const whitelistAbi = ["function owner() view returns (address)"];

    async function checkAdmin() {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const contract = new ethers.Contract(WHITELIST_CONTRACT, whitelistAbi, provider);
        const owner = await contract.owner();
        if (owner.toLowerCase() === account.toLowerCase()) {
          document.getElementById("adminBox").style.display = "block";
        }
      } catch (e) {
        console.error("管理员检测失败:", e.message);
      }
    }

    function goAdmin() {
      window.location.href = "admin.html?account=" + account;
    }

    async function fetchBalance(tokenAddr, elId) {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const contract = new ethers.Contract(tokenAddr, erc20Abi, provider);
        const decimals = await contract.decimals();
        const symbol = await contract.symbol();
        const balance = await contract.balanceOf(account);
        const formatted = ethers.utils.formatUnits(balance, decimals);
        document.getElementById(elId).innerText = formatted + " " + symbol;
      } catch (e) {
        document.getElementById(elId).innerText = "❌ 余额获取失败";
      }
    }

    async function fetchPrice(pairAddr, elId, label) {
      try {
        const res = await fetch("https://api.dexscreener.com/latest/dex/pairs/bsc/" + pairAddr);
        const data = await res.json();
        if (data && data.pairs && data.pairs.length > 0) {
          document.getElementById(elId).innerText = label + ": " + data.pairs[0].priceUsd + " USD";
        } else {
          document.getElementById(elId).innerText = "⚠️ 未找到 " + label;
        }
      } catch (e) {
        document.getElementById(elId).innerText = "❌ 获取失败";
      }
    }

    function refresh() {
      checkAdmin();
      fetchBalance(RONGCHAIN_TOKEN, "balance");
      fetchBalance(CRC_TOKEN, "crcBalance");
      fetchPrice(RONGCHAIN_USDT_PAIR, "price", "RongChain/USDT");
      fetchPrice(RONGCHAIN_CRC_PAIR, "crcPrice", "RongChain/CRC");
    }

    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
