<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>管理后台（v1.55）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="ver">v1.55</div>
  <div class="content">
    <h1>管理后台</h1>
    <div id="wallet" class="muted">钱包地址: 检测中...</div>
    <div id="owner" class="muted">合约 Owner: 检测中...</div>
    <div id="adminStatus" class="muted">权限检测中...</div>

    <div class="box">
      <div class="label">白名单管理</div>
      <input type="text" id="wlAddr" placeholder="输入钱包地址" style="width:100%;padding:6px;margin-bottom:8px;">
      <button onclick="addWL()">添加白名单</button>
      <button onclick="removeWL()">移除白名单</button>
    </div>

    <div class="box">
      <div class="label">转移 Owner</div>
      <input type="text" id="newOwner" placeholder="新 Owner 地址" style="width:100%;padding:6px;margin-bottom:8px;">
      <button onclick="transferOwner()">转移</button>
    </div>

    <div class="box">
      <button onclick="goHome()">返回首页</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const whitelistAbi = [
      "function owner() view returns (address)",
      "function isWhitelisted(address) view returns (bool)",
      "function addWhitelist(address) external",
      "function removeWhitelist(address) external",
      "function transferOwnership(address) external"
    ];

    const whitelistAddr = "在这里填你部署的 Whitelist 合约地址"; 

    let provider, signer, contract, account;

    async function init(){
      if(!window.ethereum){ alert("请在钱包内打开"); return; }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      account = await signer.getAddress();
      document.getElementById("wallet").innerText = "钱包地址: " + account;

      contract = new ethers.Contract(whitelistAddr, whitelistAbi, signer);

      try{
        const owner = await contract.owner();
        document.getElementById("owner").innerText = "合约 Owner: " + owner;
        if(owner.toLowerCase() === account.toLowerCase()){
          document.getElementById("adminStatus").innerText = "✅ 你是合约 Owner";
        }else{
          const isWL = await contract.isWhitelisted(account);
          document.getElementById("adminStatus").innerText = isWL ? "✅ 你在白名单中" : "❌ 无权限";
        }
      }catch(e){
        document.getElementById("adminStatus").innerText = "❌ 检查失败: " + (e.message||e);
      }
    }

    async function addWL(){
      const addr = document.getElementById("wlAddr").value.trim();
      if(!addr) return alert("请输入地址");
      try{ await contract.addWhitelist(addr); alert("已提交交易"); }
      catch(e){ alert("失败: "+(e.message||e)); }
    }

    async function removeWL(){
      const addr = document.getElementById("wlAddr").value.trim();
      if(!addr) return alert("请输入地址");
      try{ await contract.removeWhitelist(addr); alert("已提交交易"); }
      catch(e){ alert("失败: "+(e.message||e)); }
    }

    async function transferOwner(){
      const addr = document.getElementById("newOwner").value.trim();
      if(!addr) return alert("请输入新 Owner 地址");
      try{ await contract.transferOwnership(addr); alert("已提交交易"); }
      catch(e){ alert("失败: "+(e.message||e)); }
    }

    function goHome(){ window.location.href="home.html"; }

    init();
  </script>
</body>
</html>
